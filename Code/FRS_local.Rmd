---
title: "FRS_bryan"
author: "Bryan Kim"
date: "10/28/2020"
output: pdf_document
---


```{r, message=FALSE}
######################################################################
#### ESTIMATING THE 10 YEAR CARDIOVASCULAR DISEASE RISK IN ADULTS ####
######################################################################

# Originating from the Framingham Risk Study, the model is based on a Cox Proportional Hazard Model

### Required packages ###
library(ggplot2); library(dplyr); library(tidyr);library(haven);library(readstata13);library(foreign);library(mice);library(MatchIt);library(stringdist);library(RecordLinkage)
### Parameters ###
f_base10 = 0.95012 # baseline 10-year survival for females
m_base10 = 0.88936 # baseline 10-year survival for males

f_rf <- list(log_age = 2.32888, log_hdl = -0.70833,log_totchol = 1.20904,log_SBP = 2.82263,Smoking = 0.52873,Diabetes = 0.69154) #  log of hazard ratio for each risk factor for females
m_rf <- list(log_age = 3.06117, log_hdl = -0.93263,log_totchol = 1.12370,log_SBP = 1.99881,Smoking = 0.65451,Diabetes = 0.57367) #  log of hazard ratio for each risk factor for males 
m_log_age = 3.06117; m_log_hdl = -0.93263;m_log_totchol = 1.12370;m_log_SBP = 1.99881;m_Smoking = 0.65451;m_Diabetes = 0.57367 #  log of hazard ratio for each risk factor for males 
f_log_age = 2.32888; f_log_hdl = -0.70833;f_log_totchol = 1.20904;f_log_SBP = 2.82263;f_Smoking = 0.52873;f_Diabetes = 0.69154 #  log of hazard ratio for each risk factor for females

betas <- list(f=f_rf,m=m_rf) # nested list of f_rf and m_rf

f_points=data.frame("points"=seq(-3,12),"age_low"=c(NA,NA,NA,30,NA,35,NA,40,45,NA,50,55,60,65,70,75),"age_high"=c(NA,NA,NA,34,NA,39,NA,44,49,NA,54,59,64,69,74,120),"HDL_low"=c(NA,60,50,45,35,0,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"HDL_high"=c(NA,1000,59,49,44,35,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"TotChol_low"=c(NA,NA,NA,0,160,NA,200,240,280,NA,NA,NA,NA,NA,NA,NA),"TotChol_high"=c(NA,NA,NA,160,199,NA,239,279,1000,NA,NA,NA,NA,NA,NA,NA), "SBP_low"=c(NA,NA,0,NA,NA,NA,120,130,NA,140,150,160,NA,NA,NA,NA),"SBP_high"=c(NA,NA,120,NA,NA,NA,129,139,NA,149,159,1000,NA,NA,NA,NA), "Smoker"=c(NA,NA,NA,"No",NA,NA,"Yes",NA,NA,NA,NA,NA,NA,NA,NA,NA), "Diabetic"=c(NA,NA,NA,"No",NA,NA,NA,"Yes",NA,NA,NA,NA,NA,NA,NA,NA))
m_points=data.frame("points"=seq(-2,15),"age_low"=c(NA,NA,30,NA,35,NA,NA,40,45,NA,50,NA,55,60,65,NA,70,75),"age_high"=c(NA,NA,34,NA,39,NA,NA,44,49,NA,54,NA,59,64,69,NA,74,120),"HDL_low"=c(60,50,45,35,0,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"HDL_high"=c(1000,59,49,44,35,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"TotChol_low"=c(NA,NA,0,160,200,240,280,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"TotChol_high"=c(NA,NA,160,199,239,279,1000,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA), "SBP_low"=c(NA,NA,0,NA,120,130,140,160,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),"SBP_high"=c(NA,NA,120,NA,129,139,149,1000,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA), "Smoker"=c(NA,NA,"No",NA,NA,NA,"Yes",NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA), "Diabetic"=c(NA,NA,"No",NA,NA,"Yes",NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA))


################################################################################################################################################################
# This gets the row where the input (30 in this example) satisfies the condition that it is between the age_low and age_high columns of the data frame f_points
i=sapply(30, function(p) { which(f_points$age_low <= p & f_points$age_high >= p)})
# Delete all rows except row "i"
keep_df=f_points[-(setdiff(1:16,i)),]
################################################################################################################################################################

get_frs = function(riagendr,ridageyr,HDL,TotChol,sbp,smoker,diabetic) {
  list_pts=c() # Initiate list of points
  #### MALES ####
  if (riagendr == 1) {
   ## GET POINTS FROM AGE ##
  i=sapply(ridageyr, function(p) { which(m_points$age_low <= p & m_points$age_high >= p)}); keep_df=m_points[-(setdiff(1:length(m_points$points),i)),];m_age <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]]) 
  ## GET POINTS FROM HDL ##
  i=sapply(HDL, function(p) { which(m_points$HDL_low <= p & m_points$HDL_high >= p)}); keep_df=m_points[-(setdiff(1:length(m_points$points),i)),];m_HDL <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM TOTAL CHOLESTEROL ##
  i=sapply(TotChol, function(p) { which(m_points$TotChol_low <= p & m_points$TotChol_high >= p)}); keep_df=m_points[-(setdiff(1:length(m_points$points),i)),];m_TotChol <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM SBP ##
  i=sapply(sbp, function(p) { which(m_points$SBP_low <= p & m_points$SBP_high >= p)}); keep_df=m_points[-(setdiff(1:length(m_points$points),i)),];m_SBP <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM SMOKER ##
  if (isTRUE(smoker == 2)) {list_pts=append(list_pts,0)} else {list_pts=append(list_pts,4)}
  # m_smoke <<- 4
  ## GET POINTS FROM DIABETIC ##
  # if (isTRUE(diabetic < 6.5)) {list_pts=append(list_pts,0)} else {list_pts=append(list_pts,3)}
  if (isTRUE(diabetic >= 126)) {list_pts=append(list_pts,3)} else {list_pts=append(list_pts,0)}
  # m_diabetic <<- 3
  }
  #### FEMALES ####
 else {
     ## GET POINTS FROM AGE ##
  i=sapply(ridageyr, function(p) { which(f_points$age_low <= p & f_points$age_high >= p)}); keep_df=f_points[-(setdiff(1:length(f_points$points),i)),];f_age <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]]) 
  ## GET POINTS FROM HDL ##
  i=sapply(HDL, function(p) { which(f_points$HDL_low <= p & f_points$HDL_high >= p)}); keep_df=f_points[-(setdiff(1:length(f_points$points),i)),];f_HDL <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM TOTAL CHOLESTEROL ##
  i=sapply(TotChol, function(p) { which(f_points$TotChol_low <= p & f_points$TotChol_high >= p)}); keep_df=f_points[-(setdiff(1:length(f_points$points),i)),];f_TotChol <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM SBP ##
  i=sapply(sbp, function(p) { which(f_points$SBP_low <= p & f_points$SBP_high >= p)}); keep_df=f_points[-(setdiff(1:length(f_points$points),i)),];f_SBP <<- keep_df[[1]]
  list_pts=append(list_pts,keep_df[[1]])
  ## GET POINTS FROM SMOKER ##
  if (isTRUE(smoker == 2)) {list_pts=append(list_pts,0)} else {list_pts=append(list_pts,3)}
  # f_smoke <<- 3
  ## GET POINTS FROM DIABETIC ##
  # if (isTRUE(diabetic <  6.5)) {list_pts=append(list_pts,0)} else {list_pts=append(list_pts,4)}
    if (isTRUE(diabetic >= 126)) {list_pts=append(list_pts,4)} else {list_pts=append(list_pts,0)}
  # f_diabetic <<- 4
  }
  return(sum(list_pts))
}

########################################################################################################

get_cox_frs = function(riagendr,ridageyr,HDL,TotChol,sbp,smoker,diabetic,wt) {
  risk <<- 0
  #### MALES ####
  if (riagendr == 1) {
   arg1 <<- sum((m_log_age*log(ridageyr)),(m_log_hdl*log(HDL)),(m_log_totchol*log(TotChol)),(m_log_SBP*log(sbp)),(m_Smoking*smoker),(m_Diabetes*diabetic))
   #m_age <<- weighted.mean(ridageyr,wt);m_HDL=weighted.mean(HDL,wt);m_TotChol=weighted.mean(TotChol,wt);m_sbp=weighted.mean(sbp,wt);m_smoke=weighted.mean(smoker,wt);m_diabetic=weighted.mean(diabetic,wt)
    arg2 <<- sum((m_rf[[1]]*log(m_age)),(m_rf[[2]]*log(m_HDL)),(m_rf[[3]]*log(m_TotChol)),(m_rf[[4]]*log(m_sbp)),(m_rf[[5]]*m_smoke),(m_rf[[6]]*m_diabetic))
    risk <<- 1 - (m_base10^(exp(arg1-arg2)))
  }
  #### FEMALES ####
 else {
     arg1 <<- sum((f_log_age*log(ridageyr)),(f_log_hdl*log(HDL)),(f_log_totchol*log(TotChol)),(f_log_SBP*log(sbp)),(f_Smoking*smoker),(f_Diabetes*diabetic))
   #m_age <<- weighted.mean(ridageyr,wt);m_HDL=weighted.mean(HDL,wt);m_TotChol=weighted.mean(TotChol,wt);m_sbp=weighted.mean(sbp,wt);m_smoke=weighted.mean(smoker,wt);m_diabetic=weighted.mean(diabetic,wt)
    arg2 <<- sum((f_rf[[1]]*log(m_age)),(f_rf[[2]]*log(m_HDL)),(f_rf[[3]]*log(m_TotChol)),(f_rf[[4]]*log(m_sbp)),(f_rf[[5]]*m_smoke),(f_rf[[6]]*m_diabetic))
    risk <<- 1 - (f_base10^(exp(arg1-arg2)))
  }
  return(risk)
}

########################################################################################################

################################################################################################################################################################
# THE AVERAGES IN THE COX MODEL DEPEND ON OUR PARTICULAR SAMPLE AND THE CHARACTERISTICS OF THAT SAMPLE.

### COX MODEL ESTIMATE ###
# FEMALES
# arg1_f = betas$f$log_age*log(age)+betas$f$log_totchol*log(TotChol)+betas$f$log_hdl*log(HDL)+betas$f$log_SBP*log(sbp)+betas$f$Smoking*smoker+betas$f$Diabetes*diabetic
# arg2_f = 0 # THE MEAN VALUES HERE #
# 
# rho_f = 1-(f_base10_survival^exp(arg1_f - arg2_f))
# # MALES
# arg1_m = betas$m$log_age*log(age)+betas$m$log_totchol*log(TotChol)+betas$m$log_hdl*log(HDL)+betas$m$log_SBP*log(sbp)+betas$m$Smoking*smoker+betas$m$Diabetes*diabetic
# arg2_m= 0  # THE MEAN VALUES HERE #
# 
# rho_m = 1-(m_base10_survival^exp(arg1_m - arg2_m))
```

### NHANES continuous ###
```{r}
# order: riagendr,ridageyr,HDL,TotChol,sbp,smoker,diabetic
##########################################
##               1999-2000              ##
##########################################
nhanes1999_2000=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_1999_2000_frs.dta")
# Getting cox model based risk levels
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("riagendr","ridageyr","lbdhdl","lbxtc","bpxsar","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes1999_2000$ridageyr,nhanes1999_2000$wtint2yr)
m_HDL= weighted.mean(nhanes1999_2000$lbdhdl,nhanes1999_2000$wtint2yr)
m_TotChol = weighted.mean(nhanes1999_2000$lbxtc,nhanes1999_2000$wtint2yr)
m_sbp = weighted.mean(nhanes1999_2000$bpxsar,nhanes1999_2000$wtint2yr)
m_smoke = weighted.mean(nhanes1999_2000$isSmoker,nhanes1999_2000$wtint2yr)
m_diabetic = weighted.mean(nhanes1999_2000$isDiabetic,nhanes1999_2000$wtint2yr)

nhanes1999_2000$cox_frs = mapply(get_cox_frs, nhanes1999_2000$riagendr,nhanes1999_2000$ridageyr,nhanes1999_2000$lbdhdl,nhanes1999_2000$lbxtc,nhanes1999_2000$bpxsar,nhanes1999_2000$isSmoker,nhanes1999_2000$isDiabetic,nhanes1999_2000$wtint2yr)
nhanes1999_2000$frs = mapply(get_frs, nhanes1999_2000$riagendr,nhanes1999_2000$ridageyr,nhanes1999_2000$lbdhdl,nhanes1999_2000$lbxtc,nhanes1999_2000$bpxsar,nhanes1999_2000$isSmoker,nhanes1999_2000$fpg)

write_dta(nhanes1999_2000, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_1999_2000_frs.dta")

##########################################
##               2001-2002             ##
##########################################


nhanes2001_2002=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2001_2002_frs.dta")
# Getting cox model based risk levels
nhanes2001_2002= nhanes2001_2002[complete.cases(nhanes2001_2002[ , c("riagendr","ridageyr","lbdhdl","lbxtc","bpxsar","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2001_2002$ridageyr,nhanes2001_2002$wtint2yr)
m_HDL= weighted.mean(nhanes2001_2002$lbdhdl,nhanes2001_2002$wtint2yr)
m_TotChol = weighted.mean(nhanes2001_2002$lbxtc,nhanes2001_2002$wtint2yr)
m_sbp = weighted.mean(nhanes2001_2002$bpxsar,nhanes2001_2002$wtint2yr)
m_smoke = weighted.mean(nhanes2001_2002$isSmoker,nhanes2001_2002$wtint2yr)
m_diabetic = weighted.mean(nhanes2001_2002$isDiabetic,nhanes2001_2002$wtint2yr)

nhanes2001_2002$cox_frs = mapply(get_cox_frs, nhanes2001_2002$riagendr,nhanes2001_2002$ridageyr,nhanes2001_2002$lbdhdl,nhanes2001_2002$lbxtc,nhanes2001_2002$bpxsar,nhanes2001_2002$isSmoker,nhanes2001_2002$isDiabetic,nhanes2001_2002$wtint2yr)
nhanes2001_2002$frs = mapply(get_frs, nhanes2001_2002$riagendr,nhanes2001_2002$ridageyr,nhanes2001_2002$lbdhdl,nhanes2001_2002$lbxtc,nhanes2001_2002$bpxsar,nhanes2001_2002$isSmoker,nhanes2001_2002$fpg)

write_dta(nhanes2001_2002, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2001_2002_frs.dta")

##########################################
##               2003_2004             ##
##########################################


nhanes2003_2004=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2003_2004_frs.dta")
# Getting cox model based risk levels
nhanes2003_2004= nhanes2003_2004[complete.cases(nhanes2003_2004[ , c("riagendr","ridageyr","lbxhdd","lbxtc","bpxsar","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2003_2004$ridageyr,nhanes2003_2004$wtint2yr)
m_HDL= weighted.mean(nhanes2003_2004$lbxhdd,nhanes2003_2004$wtint2yr)
m_TotChol = weighted.mean(nhanes2003_2004$lbxtc,nhanes2003_2004$wtint2yr)
m_sbp = weighted.mean(nhanes2003_2004$bpxsar,nhanes2003_2004$wtint2yr)
m_smoke = weighted.mean(nhanes2003_2004$isSmoker,nhanes2003_2004$wtint2yr)
m_diabetic = weighted.mean(nhanes2003_2004$isDiabetic,nhanes2003_2004$wtint2yr)

nhanes2003_2004$cox_frs = mapply(get_cox_frs, nhanes2003_2004$riagendr,nhanes2003_2004$ridageyr,nhanes2003_2004$lbxhdd,nhanes2003_2004$lbxtc,nhanes2003_2004$bpxsar,nhanes2003_2004$isSmoker,nhanes2003_2004$isDiabetic,nhanes2003_2004$wtint2yr)
nhanes2003_2004$frs = mapply(get_frs, nhanes2003_2004$riagendr,nhanes2003_2004$ridageyr,nhanes2003_2004$lbxhdd,nhanes2003_2004$lbxtc,nhanes2003_2004$bpxsar,nhanes2003_2004$isSmoker,nhanes2003_2004$fpg)

write_dta(nhanes2003_2004, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2003_2004_frs.dta")

##########################################
##               2005_2006            ##
##########################################


nhanes2005_2006=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2005_2006_frs.dta")
# Getting cox model based risk levels
nhanes2005_2006= nhanes2005_2006[complete.cases(nhanes2005_2006[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2005_2006$ridageyr,nhanes2005_2006$wtint2yr)
m_HDL= weighted.mean(nhanes2005_2006$lbdhdd,nhanes2005_2006$wtint2yr)
m_TotChol = weighted.mean(nhanes2005_2006$lbxtc,nhanes2005_2006$wtint2yr)
m_sbp = weighted.mean(nhanes2005_2006$asbp,nhanes2005_2006$wtint2yr)
m_smoke = weighted.mean(nhanes2005_2006$isSmoker,nhanes2005_2006$wtint2yr)
m_diabetic = weighted.mean(nhanes2005_2006$isDiabetic,nhanes2005_2006$wtint2yr)

nhanes2005_2006$cox_frs = mapply(get_cox_frs, nhanes2005_2006$riagendr,nhanes2005_2006$ridageyr,nhanes2005_2006$lbdhdd,nhanes2005_2006$lbxtc,nhanes2005_2006$asbp,nhanes2005_2006$isSmoker,nhanes2005_2006$isDiabetic,nhanes2005_2006$wtint2yr)
nhanes2005_2006$frs = mapply(get_frs, nhanes2005_2006$riagendr,nhanes2005_2006$ridageyr,nhanes2005_2006$lbdhdd,nhanes2005_2006$lbxtc,nhanes2005_2006$asbp,nhanes2005_2006$isSmoker,nhanes2005_2006$fpg)

write_dta(nhanes2005_2006, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2005_2006_frs.dta")

##########################################
##               2007_2008          ##
##########################################

nhanes2007_2008=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2007_2008_frs.dta")
# Getting cox model based risk levels
nhanes2007_2008= nhanes2007_2008[complete.cases(nhanes2007_2008[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2007_2008$ridageyr,nhanes2007_2008$wtint2yr)
m_HDL= weighted.mean(nhanes2007_2008$lbdhdd,nhanes2007_2008$wtint2yr)
m_TotChol = weighted.mean(nhanes2007_2008$lbxtc,nhanes2007_2008$wtint2yr)
m_sbp = weighted.mean(nhanes2007_2008$asbp,nhanes2007_2008$wtint2yr)
m_smoke = weighted.mean(nhanes2007_2008$isSmoker,nhanes2007_2008$wtint2yr)
m_diabetic = weighted.mean(nhanes2007_2008$isDiabetic,nhanes2007_2008$wtint2yr)

nhanes2007_2008$cox_frs = mapply(get_cox_frs, nhanes2007_2008$riagendr,nhanes2007_2008$ridageyr,nhanes2007_2008$lbdhdd,nhanes2007_2008$lbxtc,nhanes2007_2008$asbp,nhanes2007_2008$isSmoker,nhanes2007_2008$isDiabetic,nhanes2007_2008$wtint2yr)
nhanes2007_2008$frs = mapply(get_frs, nhanes2007_2008$riagendr,nhanes2007_2008$ridageyr,nhanes2007_2008$lbdhdd,nhanes2007_2008$lbxtc,nhanes2007_2008$asbp,nhanes2007_2008$isSmoker,nhanes2007_2008$fpg)

write_dta(nhanes2007_2008, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2007_2008_frs.dta")

##########################################
##               2009_2010          ##
##########################################


nhanes2009_2010=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2009_2010_frs.dta")
# Getting cox model based risk levels
nhanes2009_2010= nhanes2009_2010[complete.cases(nhanes2009_2010[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2009_2010$ridageyr,nhanes2009_2010$wtint2yr)
m_HDL= weighted.mean(nhanes2009_2010$lbdhdd,nhanes2009_2010$wtint2yr)
m_TotChol = weighted.mean(nhanes2009_2010$lbxtc,nhanes2009_2010$wtint2yr)
m_sbp = weighted.mean(nhanes2009_2010$asbp,nhanes2009_2010$wtint2yr)
m_smoke = weighted.mean(nhanes2009_2010$isSmoker,nhanes2009_2010$wtint2yr)
m_diabetic = weighted.mean(nhanes2009_2010$isDiabetic,nhanes2009_2010$wtint2yr)

nhanes2009_2010$cox_frs = mapply(get_cox_frs, nhanes2009_2010$riagendr,nhanes2009_2010$ridageyr,nhanes2009_2010$lbdhdd,nhanes2009_2010$lbxtc,nhanes2009_2010$asbp,nhanes2009_2010$isSmoker,nhanes2009_2010$isDiabetic,nhanes2009_2010$wtint2yr)
nhanes2009_2010$frs = mapply(get_frs, nhanes2009_2010$riagendr,nhanes2009_2010$ridageyr,nhanes2009_2010$lbdhdd,nhanes2009_2010$lbxtc,nhanes2009_2010$asbp,nhanes2009_2010$isSmoker,nhanes2009_2010$fpg)

write_dta(nhanes2009_2010, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2009_2010_frs.dta")

##########################################
##               2009_2010          ##
##########################################

nhanes2011_2012=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2011_2012_frs.dta")
# Getting cox model based risk levels
nhanes2011_2012= nhanes2011_2012[complete.cases(nhanes2011_2012[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2011_2012$ridageyr,nhanes2011_2012$wtint2yr)
m_HDL= weighted.mean(nhanes2011_2012$lbdhdd,nhanes2011_2012$wtint2yr)
m_TotChol = weighted.mean(nhanes2011_2012$lbxtc,nhanes2011_2012$wtint2yr)
m_sbp = weighted.mean(nhanes2011_2012$asbp,nhanes2011_2012$wtint2yr)
m_smoke = weighted.mean(nhanes2011_2012$isSmoker,nhanes2011_2012$wtint2yr)
m_diabetic = weighted.mean(nhanes2011_2012$isDiabetic,nhanes2011_2012$wtint2yr)

nhanes2011_2012$cox_frs = mapply(get_cox_frs, nhanes2011_2012$riagendr,nhanes2011_2012$ridageyr,nhanes2011_2012$lbdhdd,nhanes2011_2012$lbxtc,nhanes2011_2012$asbp,nhanes2011_2012$isSmoker,nhanes2011_2012$isDiabetic,nhanes2011_2012$wtint2yr)
nhanes2011_2012$frs = mapply(get_frs, nhanes2011_2012$riagendr,nhanes2011_2012$ridageyr,nhanes2011_2012$lbdhdd,nhanes2011_2012$lbxtc,nhanes2011_2012$asbp,nhanes2011_2012$isSmoker,nhanes2011_2012$fpg)

write_dta(nhanes2011_2012, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2011_2012_frs.dta")

##########################################
##               2009_2010          ##
##########################################

nhanes2013_2014=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2013_2014_frs.dta")
# Getting cox model based risk levels
nhanes2013_2014= nhanes2013_2014[complete.cases(nhanes2013_2014[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2013_2014$ridageyr,nhanes2013_2014$wtint2yr)
m_HDL= weighted.mean(nhanes2013_2014$lbdhdd,nhanes2013_2014$wtint2yr)
m_TotChol = weighted.mean(nhanes2013_2014$lbxtc,nhanes2013_2014$wtint2yr)
m_sbp = weighted.mean(nhanes2013_2014$asbp,nhanes2013_2014$wtint2yr)
m_smoke = weighted.mean(nhanes2013_2014$isSmoker,nhanes2013_2014$wtint2yr)
m_diabetic = weighted.mean(nhanes2013_2014$isDiabetic,nhanes2013_2014$wtint2yr)

nhanes2013_2014$cox_frs = mapply(get_cox_frs, nhanes2013_2014$riagendr,nhanes2013_2014$ridageyr,nhanes2013_2014$lbdhdd,nhanes2013_2014$lbxtc,nhanes2013_2014$asbp,nhanes2013_2014$isSmoker,nhanes2013_2014$isDiabetic,nhanes2013_2014$wtint2yr)
nhanes2013_2014$frs = mapply(get_frs, nhanes2013_2014$riagendr,nhanes2013_2014$ridageyr,nhanes2013_2014$lbdhdd,nhanes2013_2014$lbxtc,nhanes2013_2014$asbp,nhanes2013_2014$isSmoker,nhanes2013_2014$fpg)

write_dta(nhanes2013_2014, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2013_2014_frs.dta")

##########################################
##               2009_2010          ##
##########################################

nhanes2015_2016=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2015_2016_frs.dta")
# Getting cox model based risk levels
nhanes2015_2016= nhanes2015_2016[complete.cases(nhanes2015_2016[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2015_2016$ridageyr,nhanes2015_2016$wtint2yr)
m_HDL= weighted.mean(nhanes2015_2016$lbdhdd,nhanes2015_2016$wtint2yr)
m_TotChol = weighted.mean(nhanes2015_2016$lbxtc,nhanes2015_2016$wtint2yr)
m_sbp = weighted.mean(nhanes2015_2016$asbp,nhanes2015_2016$wtint2yr)
m_smoke = weighted.mean(nhanes2015_2016$isSmoker,nhanes2015_2016$wtint2yr)
m_diabetic = weighted.mean(nhanes2015_2016$isDiabetic,nhanes2015_2016$wtint2yr)

nhanes2015_2016$cox_frs = mapply(get_cox_frs, nhanes2015_2016$riagendr,nhanes2015_2016$ridageyr,nhanes2015_2016$lbdhdd,nhanes2015_2016$lbxtc,nhanes2015_2016$asbp,nhanes2015_2016$isSmoker,nhanes2015_2016$isDiabetic,nhanes2015_2016$wtint2yr)
nhanes2015_2016$frs = mapply(get_frs, nhanes2015_2016$riagendr,nhanes2015_2016$ridageyr,nhanes2015_2016$lbdhdd,nhanes2015_2016$lbxtc,nhanes2015_2016$asbp,nhanes2015_2016$isSmoker,nhanes2015_2016$fpg)

write_dta(nhanes2015_2016, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2015_2016_frs.dta")

##########################################
##               2009_2010          ##
##########################################

nhanes2017_2018=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2017_2018_frs.dta")
# Getting cox model based risk levels
nhanes2017_2018= nhanes2017_2018[complete.cases(nhanes2017_2018[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","isDiabetic")]),]
m_age = weighted.mean(nhanes2017_2018$ridageyr,nhanes2017_2018$wtint2yr)
m_HDL= weighted.mean(nhanes2017_2018$lbdhdd,nhanes2017_2018$wtint2yr)
m_TotChol = weighted.mean(nhanes2017_2018$lbxtc,nhanes2017_2018$wtint2yr)
m_sbp = weighted.mean(nhanes2017_2018$asbp,nhanes2017_2018$wtint2yr)
m_smoke = weighted.mean(nhanes2017_2018$isSmoker,nhanes2017_2018$wtint2yr)
m_diabetic = weighted.mean(nhanes2017_2018$isDiabetic,nhanes2017_2018$wtint2yr)

nhanes2017_2018$cox_frs = mapply(get_cox_frs, nhanes2017_2018$riagendr,nhanes2017_2018$ridageyr,nhanes2017_2018$lbdhdd,nhanes2017_2018$lbxtc,nhanes2017_2018$asbp,nhanes2017_2018$isSmoker,nhanes2017_2018$isDiabetic,nhanes2017_2018$wtint2yr)
nhanes2017_2018$frs = mapply(get_frs, nhanes2017_2018$riagendr,nhanes2017_2018$ridageyr,nhanes2017_2018$lbdhdd,nhanes2017_2018$lbxtc,nhanes2017_2018$asbp,nhanes2017_2018$isSmoker,nhanes2017_2018$fpg)


write_dta(nhanes2017_2018, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2017_2018_frs.dta")

##########################################
##               NHANES III          ##
##########################################
nhanesIII=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_frs.dta")

nhanesIIIP1=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_P1x_frs.dta")
nhanesIIIP2=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_P2x_frs.dta")

## Dropping rows where values of our risk factor variables are NA
nhanesIII= nhanesIII[complete.cases(nhanesIII[ , c("HSSEX","HSAGEIR","HDP","TCP","PEPMNK1R","smoke_sts","isDiabetic")]),]
nhanesIIIP1= nhanesIIIP1[complete.cases(nhanesIIIP1[ , c("HSSEX","HSAGEIR","HDP","TCP","PEPMNK1R","smoke_sts","isDiabetic")]),]
nhanesIIIP2= nhanesIIIP2[complete.cases(nhanesIIIP2[ , c("HSSEX","HSAGEIR","HDP","TCP","PEPMNK1R","smoke_sts","isDiabetic")]),]

## GETTING COX FRS SCORES!!
nhanesIII$cox_frs = mapply(get_cox_frs, nhanesIII$HSSEX,nhanesIII$HSAGEIR,nhanesIII$HDP,nhanesIII$TCP,nhanesIII$PEPMNK1R,nhanesIII$isSmoker,nhanesIII$isDiabetic,nhanesIII$WTPFHX1)
nhanesIIIP1$cox_frs = mapply(get_cox_frs, nhanesIIIP1$HSSEX,nhanesIIIP1$HSAGEIR,nhanesIIIP1$HDP,nhanesIIIP1$TCP,nhanesIIIP1$PEPMNK1R,nhanesIIIP1$isSmoker,nhanesIIIP1$isDiabetic,nhanesIIIP1$WTPFHX1)
nhanesIIIP2$cox_frs = mapply(get_cox_frs, nhanesIIIP2$HSSEX,nhanesIIIP2$HSAGEIR,nhanesIIIP2$HDP,nhanesIIIP2$TCP,nhanesIIIP2$PEPMNK1R,nhanesIIIP2$isSmoker,nhanesIIIP2$isDiabetic,nhanesIIIP2$WTPFHX1)

# THIS WAS PREVIOUSLY A PROBLEM - INFLATED THE GLYCOHEMOGLOBIN NUMBERS
# nhanesIIIP1 = filter(nhanesIIIP1,GHP != 8888)
# nhanesIIIP2 = filter(nhanesIIIP2,GHP != 8888)
write_dta(nhanesIIIP1, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_frs.dta")
write_dta(nhanesIIIP1, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_P1x_frs.dta")
write_dta(nhanesIIIP2, "/Users/bryankim/Documents/NBER/Framingham /Data/nhanesIII_P2x_frs.dta")


```

### UPDATE isDIABETIC for new FPG variable
```{r}
nhanes1999_2000$isDiabetic = ifelse(nhanes1999_2000$fpg >= 126,1,0)
nhanes2001_2002$isDiabetic = ifelse(nhanes2001_2002$fpg >= 126,1,0)
nhanes2003_2004$isDiabetic = ifelse(nhanes2003_2004$fpg >= 126,1,0)
nhanes2005_2006$isDiabetic = ifelse(nhanes2005_2006$fpg >= 126,1,0)
nhanes2007_2008$isDiabetic = ifelse(nhanes2007_2008$fpg >= 126,1,0)
nhanes2009_2010$isDiabetic = ifelse(nhanes2009_2010$fpg >= 126,1,0)
nhanes2011_2012$isDiabetic = ifelse(nhanes2011_2012$fpg >= 126,1,0)
nhanes2013_2014$isDiabetic = ifelse(nhanes2013_2014$fpg >= 126,1,0)
nhanes2015_2016$isDiabetic = ifelse(nhanes2015_2016$fpg >= 126,1,0)
nhanes2017_2018$isDiabetic = ifelse(nhanes2017_2018$fpg >= 126,1,0)

```


## HOW MANY OBSERVATIONS DROPEPED FOR EACH VARIABLE?
```{r}
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("riagendr")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("ridageyr")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("lbdhdl")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("lbxtc")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("bpxsar")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("isSmoker")]),]
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("isDiabetic")]),]
# ,nhanes2001_2002,
# nhanes2003_2004,
# nhanes2005_2006,
# nhanes2007_2008,
# nhanes2009_2010,
# nhanes2011_2012,
# nhanes2013_2014,
# nhanes2015_2016,
# nhanes2017_2018
for (cycle in c(nhanes1999_2000)) {
  for (input in c("riagendr","ridageyr","lbdhdl","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes1999_2000[[input]]);n=sum(is.na(nhanes1999_2000[[input]]))
    print(N-n)
  }
}

  for (input in c("riagendr","ridageyr","lbdhdl","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2001_2002[[input]]);n=sum(is.na(nhanes2001_2002[[input]]))
    print(N-n)
  }

for (cycle in c(nhanes2003_2004)) {
  for (input in c("riagendr","ridageyr","lbxhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2003_2004[[input]]);n=sum(is.na(nhanes2003_2004[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2005_2006)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2005_2006[[input]]);n=sum(is.na(nhanes2005_2006[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2007_2008)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2007_2008[[input]]);n=sum(is.na(nhanes2007_2008[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2009_2010)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2009_2010[[input]]);n=sum(is.na(nhanes2009_2010[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2011_2012)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2011_2012[[input]]);n=sum(is.na(nhanes2011_2012[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2013_2014)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2013_2014[[input]]);n=sum(is.na(nhanes2013_2014[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2015_2016)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2015_2016[[input]]);n=sum(is.na(nhanes2015_2016[[input]]))
    print(N-n)
  }
}
for (cycle in c(nhanes2017_2018)) {
  for (input in c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg")) {
    N=length(nhanes2017_2018[[input]]);n=sum(is.na(nhanes2017_2018[[input]]))
    print(N-n)
  }
}



for (input in c("fpg")) {
    N=length(nhanes2017_2018[[input]]);n=sum(is.na(nhanes2017_2018[[input]]))
    print(N-n)
  }
```


nhanes1999_2000=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_1999_2000_frs.dta")
nhanes2001_2002=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2001_2002_frs.dta")
nhanes2003_2004=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2003_2004_frs.dta")
nhanes2005_2006=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2005_2006_frs.dta")
nhanes2007_2008=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2007_2008_frs.dta")
nhanes2009_2010=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2009_2010_frs.dta")
nhanes2011_2012=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2011_2012_frs.dta")
nhanes2013_2014=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2013_2014_frs.dta")
nhanes2015_2016=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2015_2016_frs.dta")
nhanes2017_2018=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_2017_2018_frs.dta")

##############
## PIPELINE ##
##############
```{r}

filenames = list.files("/Users/bryankim/Documents/NBER/Framingham /Data",pattern = "_frs.dta",full.names = TRUE)
filenames = filenames[-c(11,12,13)]
df_list = lapply(filenames,read_dta)

############################
### RUN adjust_weights.R ###
############################
source("/Users/bryankim/Documents/NBER/Framingham /Code/adjust_weights.R")


```


#################################
## INPUTING MISSING FPG values ##
#################################
```{r}
temp=list(nhanes1999_2000,nhanes2001_2002,nhanes2003_2004,nhanes2005_2006,nhanes2007_2008,nhanes2009_2010,nhanes2011_2012,nhanes2013_2014,nhanes2015_2016,nhanes2017_2018)


## USING lapply to calculated the fitted values
# REGRESSION #1
temp = temp %>% lapply(function(x) {fit = lm(x$fpg ~ x$lbxgh);pred = predict(fit, newdata = ic(x)); mutate(x,imputed_fpg = pred)})
temp = temp %>% lapply(function(x) {mutate(x, fpg_final = ifelse(is.na(x$fpg),x$imputed_fpg,x$fpg))})
# REGRESSION #2
temp = temp %>% lapply(function(x) {fit = lm(x$fpg ~ x$lbxgh + x$M1 + x$M2 + x$M3 + x$M4 + x$F1 + x$F2 + x$F3 + x$F4);pred = predict(fit, newdata = ic(x)); x = mutate(x,imputed_fpg2 = pred)})
temp = temp %>% lapply(function(x) {mutate(x, fpg_final = ifelse(is.na(x$fpg),x$imputed_fpg2,x$fpg))})
nhanes1999_2000 = temp[[1]];nhanes2001_2002 = temp[[2]];nhanes2003_2004 = temp[[3]];nhanes2005_2006 = temp[[4]];nhanes2007_2008 = temp[[5]];nhanes2009_2010 = temp[[6]];nhanes2011_2012 = temp[[7]];nhanes2013_2014 = temp[[8]];nhanes2015_2016 = temp[[9]];nhanes2017_2018 = temp[[10]]



# TEST ON NHANES1999 to check work
output = lm(nhanes1999_2000$fpg ~ nhanes1999_2000$lbxgh, na.action = na.omit)
tidy(output)
(nhanes1999_2000$lbxgh[[1]]*(29.39178) - 58.56547)
# or
(nhanes1999_2000$lbxgh[[1]]*(coef(output)[[2]]) + (coef(output)[[1]]))
```
```{r}

######################
### COMPLETE CASES ###
######################
# Paraemters: fpg_final 
nhanes1999_2000= nhanes1999_2000[complete.cases(nhanes1999_2000[ , c("riagendr","ridageyr","lbdhdl","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2001_2002= nhanes2001_2002[complete.cases(nhanes2001_2002[ , c("riagendr","ridageyr","lbdhdl","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2003_2004= nhanes2003_2004[complete.cases(nhanes2003_2004[ , c("riagendr","ridageyr","lbxhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2005_2006= nhanes2005_2006[complete.cases(nhanes2005_2006[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2007_2008= nhanes2007_2008[complete.cases(nhanes2007_2008[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2009_2010= nhanes2009_2010[complete.cases(nhanes2009_2010[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2011_2012= nhanes2011_2012[complete.cases(nhanes2011_2012[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2013_2014= nhanes2013_2014[complete.cases(nhanes2013_2014[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2015_2016= nhanes2015_2016[complete.cases(nhanes2015_2016[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
nhanes2017_2018= nhanes2017_2018[complete.cases(nhanes2017_2018[ , c("riagendr","ridageyr","lbdhdd","lbxtc","asbp","isSmoker","fpg_final")]),]
```

######################
### get_frs SCORES ###
######################
```{r}

nhanes1999_2000$frs = mapply(get_frs, nhanes1999_2000$riagendr,nhanes1999_2000$ridageyr,nhanes1999_2000$lbdhdl,nhanes1999_2000$lbxtc,nhanes1999_2000$bpxsar,nhanes1999_2000$isSmoker,nhanes1999_2000$fpg_final)
nhanes2001_2002$frs = mapply(get_frs, nhanes2001_2002$riagendr,nhanes2001_2002$ridageyr,nhanes2001_2002$lbdhdl,nhanes2001_2002$lbxtc,nhanes2001_2002$bpxsar,nhanes2001_2002$isSmoker,nhanes2001_2002$fpg_final)
nhanes2003_2004$frs = mapply(get_frs, nhanes2003_2004$riagendr,nhanes2003_2004$ridageyr,nhanes2003_2004$lbxhdd,nhanes2003_2004$lbxtc,nhanes2003_2004$bpxsar,nhanes2003_2004$isSmoker,nhanes2003_2004$fpg_final)
nhanes2005_2006$frs = mapply(get_frs, nhanes2005_2006$riagendr,nhanes2005_2006$ridageyr,nhanes2005_2006$lbdhdd,nhanes2005_2006$lbxtc,nhanes2005_2006$asbp,nhanes2005_2006$isSmoker,nhanes2005_2006$fpg_final)
nhanes2007_2008$frs = mapply(get_frs, nhanes2007_2008$riagendr,nhanes2007_2008$ridageyr,nhanes2007_2008$lbdhdd,nhanes2007_2008$lbxtc,nhanes2007_2008$asbp,nhanes2007_2008$isSmoker,nhanes2007_2008$fpg_final)
nhanes2009_2010$frs = mapply(get_frs, nhanes2009_2010$riagendr,nhanes2009_2010$ridageyr,nhanes2009_2010$lbdhdd,nhanes2009_2010$lbxtc,nhanes2009_2010$asbp,nhanes2009_2010$isSmoker,nhanes2009_2010$fpg_final)
nhanes2011_2012$frs = mapply(get_frs, nhanes2011_2012$riagendr,nhanes2011_2012$ridageyr,nhanes2011_2012$lbdhdd,nhanes2011_2012$lbxtc,nhanes2011_2012$asbp,nhanes2011_2012$isSmoker,nhanes2011_2012$fpg_final)
nhanes2013_2014$frs = mapply(get_frs, nhanes2013_2014$riagendr,nhanes2013_2014$ridageyr,nhanes2013_2014$lbdhdd,nhanes2013_2014$lbxtc,nhanes2013_2014$asbp,nhanes2013_2014$isSmoker,nhanes2013_2014$fpg_final)
nhanes2015_2016$frs = mapply(get_frs, nhanes2015_2016$riagendr,nhanes2015_2016$ridageyr,nhanes2015_2016$lbdhdd,nhanes2015_2016$lbxtc,nhanes2015_2016$asbp,nhanes2015_2016$isSmoker,nhanes2015_2016$fpg_final)
nhanes2017_2018$frs = mapply(get_frs, nhanes2017_2018$riagendr,nhanes2017_2018$ridageyr,nhanes2017_2018$lbdhdd,nhanes2017_2018$lbxtc,nhanes2017_2018$asbp,nhanes2017_2018$isSmoker,nhanes2017_2018$fpg_final)

```

### IMPUTATION METHODS
```{r}
## This is the data with imputed FPG values using KNN method
kNN=read.csv("/Users/bryankim/Documents/NBER/Framingham /Data/kNN.csv")
kNN = kNN[,-c(1,2,4,6,8,10,12,14,16,18,20)]
## example on nhanes (1999-2000)
nhanes = read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_1999_2000_frs.dta"); nhanes= nhanes[complete.cases(nhanes[ , c("lbxgh")]),]; fit = lm(nhanes$fpg ~ nhanes$lbxgh);pred = predict(fit, newdata = ic(nhanes)); nhanes = mutate(nhanes,imputed_fpg = pred)

fit = lm(nhanes$fpg ~ nhanes$lbxgh + nhanes$M1 + nhanes$M2 + nhanes$M3 + nhanes$M4 + nhanes$F1 + nhanes$F2 + nhanes$F3 + nhanes$F4);pred = predict(fit, newdata = ic(nhanes)); nhanes = mutate(nhanes,imputed_fpg2 = pred)
nhanes = nhanes %>% mutate(fpg_final = ifelse(is.na(fpg),imputed_fpg,fpg))

nhanes$fpg_knn=kNN$X1

### Analyzing scores between complete cases of fpg and HbA1c cases. 
# I am seeing how similar each of the FPG and HbA1c tests for diabetes are. 
test=read_dta("/Users/bryankim/Documents/NBER/Framingham /Data/nhanes_1999_2000_frs.dta")
# Keeping only observations where we have BOTH FPG and HbA1c results in NHANES.
test= test[complete.cases(test[ , c("lbxgh","fpg")]),] # Gives us 1098 observations
# Dummy variable positive = 1 if both the FPG test and HbA1c test give us the same result for diabetes (or no diabetes)
test = test %>% mutate(positive = ifelse((fpg >= 126 & lbxgh > 6.5) | (fpg <= 126 & lbxgh < 6.5),1,0))
sum_pos = test %>% select(positive) %>% sum
print(sum_pos)
# So out of the 1098 observations, both tests give the same result for diabetes for 1031 observations (94% similarity)
# Merging with nhanes to use imputed values
test = merge(test,nhanes, all.x=TRUE, on="seqn")
test$diff_impute_regress = ifelse((test$imputed_fpg >= 126 & test$fpg < 126) | (test$imputed_fpg <= 126 & test$fpg > 126),1,0)
test %>% select(diff_impute_regress) %>% sum
# 63 cases where imputed values of fpg using linear regression are incorrect when compared to original fpg values
test$diff_impute_knn = ifelse((test$fpg_knn >= 126 & test$lbxgh < 6.5) | (test$fpg_knn <= 126 & test$lbxgh > 6.5),1,0)
test %>% select(diff_impute_knn) %>% sum
# 59 cases where knn values of FPG are incorrect when compared to HbA1c

### Analyzing the differences between imputation methods (knn and simple linear regression)
nhanes$diff_score = nhanes$imputed_fpg-nhanes$fpg_knn # "imputed_fpg" is the imputed fpg values using linear regression: (fpg ~ HbA1c)
# Absolute value of the mean of this "difference score".
abs(mean(nhanes$diff_score))
# = 0.055

## CHECKING CASES
nhanes$cross_val1 = ifelse((nhanes$fpg_final >= 126 & nhanes$lbxgh > 6.5) | (nhanes$fpg_final <= 126 & nhanes$lbxgh < 6.5),1,0)
nhanes$cross_val2 = ifelse((nhanes$fpg_knn >= 126 & nhanes$lbxgh > 6.5) | (nhanes$fpg_knn <= 126 & nhanes$lbxgh < 6.5),1,0)

nhanes %>% select(cross_val1) %>% sum
nhanes %>% select(cross_val2) %>% sum

nhanes$nhanes2=ifelse((nhanes$imputed_fpg>=126 & lbxgh<6.5),1,0)
nhanes$nhanes3=ifelse((nhanes$imputed_fpg>=126 & lbxgh>6.5) | (nhanes$imputed_fpg<126 & nhanes$knn>=126),1,0)

nhanes %>% select(nhanes) %>% sum
```

### LAPPLY IMPUTATION METHODS FROM KNN
```{r}
## This is the data with imputed FPG values using KNN method
kNN=read.csv("/Users/bryankim/Documents/NBER/Framingham /Data/kNN.csv")
kNN = kNN[,-c(1,2,4,6,8,10,12,14,16,18,20)]

filenames = list.files("/Users/bryankim/Documents/NBER/Framingham /Data",pattern = "_frs.dta",full.names = TRUE)
filenames = filenames[-c(11,12,13)]
df_list = lapply(filenames,read_dta)
source("/Users/bryankim/Documents/NBER/Framingham /Code/adjust_weights.R")
temp = temp %>% lapply(function(x) {x= x[complete.cases(x[ , c("lbxgh")]),]})
nhanes1999_2000 = temp[[1]];nhanes1999_2000$fpg_knn=kNN$X1[1:length(nhanes1999_2000$seqn)]
nhanes2001_2002 = temp[[2]];nhanes2001_2002$fpg_knn=kNN$X1.1[1:length(nhanes2001_2002$seqn)]
nhanes2003_2004 = temp[[3]];nhanes2003_2004$fpg_knn=kNN$X1.2[1:length(nhanes2003_2004$seqn)]
nhanes2005_2006 = temp[[4]];nhanes2005_2006$fpg_knn=kNN$X1.3[1:length(nhanes2005_2006$seqn)]
nhanes2007_2008 = temp[[5]];nhanes2007_2008$fpg_knn=kNN$X1.4[1:length(nhanes2007_2008$seqn)]
nhanes2009_2010 = temp[[6]];nhanes2009_2010$fpg_knn=kNN$X1.5[1:length(nhanes2009_2010$seqn)]
nhanes2011_2012 = temp[[7]];nhanes2011_2012$fpg_knn=kNN$X1.6[1:length(nhanes2011_2012$seqn)]
nhanes2013_2014 = temp[[8]];nhanes2013_2014$fpg_knn=kNN$X1.7[1:length(nhanes2013_2014$seqn)]
nhanes2015_2016 = temp[[9]];nhanes2015_2016$fpg_knn=kNN$X1.8[1:length(nhanes2015_2016$seqn)]
nhanes2017_2018 = temp[[10]];nhanes2017_2018$fpg_knn=kNN$X1.9[1:length(nhanes2017_2018$seqn)]

```
