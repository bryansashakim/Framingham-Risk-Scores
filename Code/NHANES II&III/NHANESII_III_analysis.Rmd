---
title: "NHANESII_III_analysis"
author: "Bryan Kim"
date: "1/13/2021"
output: pdf_document
---

########################################## 

## TABS

########################################## 

### NHANES II

```{r}
library(haven)
library(dplyr)

nhanesII=read_dta("/Users/bryankim/Documents/NBER/Case Deaton/Data/FRS/Old Framingham/NHANESII/nhanesII_frs.dta")
nhanesII = nhanesII[complete.cases(nhanesII[ , c("SEX","AGEYR_AT_INT","lbdhdd","lbxtc","asbp","curr_smq","fpg_reg")]),]

nhanesII$frs = mapply(get_frs, nhanesII$SEX,nhanesII$AGEYR_AT_INT,nhanesII$lbdhdd,nhanesII$lbxtc,nhanesII$asbp,nhanesII$curr_smq,nhanesII$fpg_reg)
# ALL
weighted.mean(nhanesII$frs,nhanesII$exam_final_wt)
weighted.mean(nhanesII$frs,nhanesII$wt)


table(nhanesII$GRADE)

#FOR NHANES II
nhanesII = nhanesII %>% filter(GRADE != 88)
tempII = list(nhanesII)
length(tempII) # should be 1
##### BY EDUCATION #####
# <HS 
# <HS 
lapply(tempII, function(x) {temp = filter(x,x$GRADE < 34);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE < 34);print(weighted.mean(temp$frs,temp$wt))})

# HS
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 34 & x$GRADE_COMPL == 1);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 34 & x$GRADE_COMPL == 1);print(weighted.mean(temp$frs,temp$wt))})

# Some College
lapply(tempII, function(x) {temp = filter(x,x$GRADE > 34 & x$GRADE < 45);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE > 34 & x$GRADE < 45);print(weighted.mean(temp$frs,temp$wt))})

# College Grad
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 45);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 45);print(weighted.mean(temp$frs,temp$wt))})

##### BY AGE #####
# 45-54
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=45 & x$AGEYR_AT_INT <=54);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=45 & x$AGEYR_AT_INT <=54);print(weighted.mean(temp$frs,temp$wt))})

# 55-64
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=55 & x$AGEYR_AT_INT <=64);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=55 & x$AGEYR_AT_INT <=64);print(weighted.mean(temp$frs,temp$wt))})

# 65-74
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=65 & x$AGEYR_AT_INT <=74);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=65 & x$AGEYR_AT_INT <=74);print(weighted.mean(temp$frs,temp$wt))})

# 75+
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=75);print(weighted.mean(temp$frs,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=75);print(weighted.mean(temp$frs,temp$wt))})



############################################################
nhanesII$isDiabetic = ifelse(nhanesII$fpg>=126,1,0)
subset=nhanesII %>% filter()
table(nhanesII$fpg,nhanesII$M1)

```

### NHANES III

```{r}
nhanesIIIP1$frs = mapply(get_frs, nhanesIIIP1$HSSEX,nhanesIIIP1$HSAGEIR,nhanesIIIP1$HDP,nhanesIIIP1$TCP,nhanesIIIP1$PEPMNK1R,nhanesIIIP1$smoke_sts,nhanesIIIP1$fpg_final)
nhanesIIIP2$frs = mapply(get_frs, nhanesIIIP2$HSSEX,nhanesIIIP2$HSAGEIR,nhanesIIIP2$HDP,nhanesIIIP2$TCP,nhanesIIIP2$PEPMNK1R,nhanesIIIP2$smoke_sts,nhanesIIIP2$fpg_final)

#FOR NHANES III
tempIII = list(nhanesIIIP1,nhanesIIIP2)
tempIIIP1 = list(nhanesIIIP1)
tempIIIP2 = list(nhanesIIIP2)

length(tempIII) # should be 2

# ALL
weighted.mean(nhanesIIIP1$frs,nhanesIIIP1$WTPFQX1)
weighted.mean(nhanesIIIP1$frs,nhanesIIIP1$wt)
weighted.mean(nhanesIIIP2$frs,nhanesIIIP2$WTPFQX2)
weighted.mean(nhanesIIIP2$frs,nhanesIIIP2$wt)

##### BY EDUCATION #####
# <HS 
# <HS 
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs,temp$wt))})

# HS
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs,temp$wt))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs,temp$wt))})

# Some College
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs,temp$wt))})

# College Grad
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs,temp$wt))})

##### BY AGE #####
# 45-54
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs,temp$wt))})

# 55-64
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs,temp$wt))})

# 65-74
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs,temp$wt))})

# 75+
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=75);print(weighted.mean(temp$frs,temp$wt))})

# 85+
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >= 85);print(weighted.mean(temp$frs,temp$wt))})

############################################################

```

# ATP-3

## NHANESII

```{r}
nhanesII_atp3 = read_dta("/Users/bryankim/Documents/NBER/Case Deaton/Data/FRS/ATP3/nhanesII_frs_atp3.dta")
View(nhanesII_atp3 %>% select("SEX","AGEYR_AT_INT","lbdhdd","lbxtc","asbp","curr_smq","treated","frs_atp3"))
table(nhanesII_atp3$AGEYR_AT_INT)

nhanesII_atp3$frs = mapply(get_frs, nhanesII_atp3$SEX,nhanesII_atp3$AGEYR_AT_INT,nhanesII_atp3$lbdhdd,nhanesII_atp3$lbxtc,nhanesII_atp3$asbp,nhanesII_atp3$curr_smq,nhanesII_atp3$fpg_reg)
# ALL
weighted.mean(nhanesII_atp3$frs,nhanesII_atp3$exam_final_wt)
weighted.mean(nhanesII_atp3$frs,nhanesII_atp3$wt)

weighted.mean(nhanesII_atp3$frs_atp3,nhanesII_atp3$exam_final_wt)
weighted.mean(nhanesII_atp3$frs_atp3,nhanesII_atp3$wt)


table(nhanesII_atp3$GRADE)

#FOR NHANES II
nhanesII_atp3 = nhanesII_atp3 %>% filter(GRADE != 88)
tempII = list(nhanesII_atp3)
length(tempII) # should be 1
##### BY EDUCATION #####
# <HS 
# <HS 
lapply(tempII, function(x) {temp = filter(x,x$GRADE < 34);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE < 34);print(weighted.mean(temp$frs_atp3,temp$wt))})

# HS
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 34 & x$GRADE_COMPL == 1);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 34 & x$GRADE_COMPL == 1);print(weighted.mean(temp$frs_atp3,temp$wt))})

# Some College
lapply(tempII, function(x) {temp = filter(x,x$GRADE > 34 & x$GRADE < 45);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE > 34 & x$GRADE < 45);print(weighted.mean(temp$frs_atp3,temp$wt))})

# College Grad
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 45);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$GRADE == 45);print(weighted.mean(temp$frs_atp3,temp$wt))})

##### BY AGE #####
# 45-54
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=45 & x$AGEYR_AT_INT <=54);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=45 & x$AGEYR_AT_INT <=54);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 55-64
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=55 & x$AGEYR_AT_INT <=64);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=55 & x$AGEYR_AT_INT <=64);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 65-74
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=65 & x$AGEYR_AT_INT <=74);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=65 & x$AGEYR_AT_INT <=74);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 75+
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=75);print(weighted.mean(temp$frs_atp3,temp$exam_final_wt))})
lapply(tempII, function(x) {temp = filter(x,x$AGEYR_AT_INT >=75);print(weighted.mean(temp$frs_atp3,temp$wt))})



############################################################
nhanesII_atp3$isDiabetic = ifelse(nhanesII_atp3$fpg>=126,1,0)
subset=nhanesII_atp3 %>% filter()
table(nhanesII_atp3$fpg,nhanesII_atp3$M1)

```

## NHANES III

```{r}
nhanesIIIP1_atp3 = read_dta("/Users/bryankim/Documents/NBER/Case Deaton/Data/FRS/ATP3/nhanesIII_P1x_frs_atp3.dta") %>% filter(HSAGEIR <= 74)
nhanesIIIP2_atp3 = read_dta("/Users/bryankim/Documents/NBER/Case Deaton/Data/FRS/ATP3/nhanesIII_P2x_frs_atp3.dta") %>% filter(HSAGEIR <= 74)

source("/Users/bryankim/Documents/NBER/Case Deaton/Code/NHANES II&III/create_wts_nhanesIII.R")

#FOR NHANES III
tempIII = list(nhanesIIIP1_atp3,nhanesIIIP2_atp3)
tempIIIP1 = list(nhanesIIIP1_atp3)
tempIIIP2 = list(nhanesIIIP2_atp3)

length(tempIII) # should be 2

# ALL
weighted.mean(nhanesIIIP1_atp3$frs_atp3,nhanesIIIP1_atp3$WTPFQX1)
weighted.mean(nhanesIIIP1_atp3$frs_atp3,nhanesIIIP1_atp3$wt)
weighted.mean(nhanesIIIP2_atp3$frs_atp3,nhanesIIIP2_atp3$WTPFQX2)
weighted.mean(nhanesIIIP2_atp3$frs_atp3,nhanesIIIP2_atp3$wt)

##### BY EDUCATION #####
# <HS 
# <HS 
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R <= 11);print(weighted.mean(temp$frs_atp3,temp$wt))})

# HS
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs_atp3,temp$wt))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R == 12);print(weighted.mean(temp$frs_atp3,temp$wt))})

# Some College
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R > 12 & x$HFA8R < 16);print(weighted.mean(temp$frs_atp3,temp$wt))})

# College Grad
lapply(tempIIIP1, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HFA8R >= 16);print(weighted.mean(temp$frs_atp3,temp$wt))})

##### BY AGE #####
# 45-54
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
```

```{r}
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=45 & x$HSAGEIR <=54);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 55-64
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=55 & x$HSAGEIR <=64);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 65-74
lapply(tempIIIP1, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs_atp3,temp$WTPFQX1))})
lapply(tempIIIP2, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs_atp3,temp$WTPFQX2))})
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=65 & x$HSAGEIR <=74);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 75+
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >=75);print(weighted.mean(temp$frs_atp3,temp$wt))})

# 85+
lapply(tempIII, function(x) {temp = filter(x,x$HSAGEIR >= 85);print(weighted.mean(temp$frs_atp3,temp$wt))})

############################################################
```

# Pooled Cohort

## equation for pooled cohort model

```{r}
# Beta Coefficients
##  beta coeff for females whites
fwhite_coeff <- list(log_age = -29.799,log_agesq = 4.884,log_totchol = 13.540,log_agextotchol = -3.114,log_hdl = -13.578, log_agexhdl = 3.149,log_SBP = 2.019,curr_smq = 7.574,log_agexcurr_smq = -1.665,Diabetes = 0.661)
##  beta coeff for males whites
### ** __males dont have age^2 factor__ **
mwhite_coeff <- list(log_age = 12.344,log_totchol = 11.853,log_agextotchol = -2.664,log_hdl = -7.990, log_agexhdl = 1.769	,log_SBP = 1.797,curr_smq = 7.837	,log_agexcurr_smq = -1.795,Diabetes = 0.658)
##  beta coeff for females Blacks
fblack_coeff <- list(log_age = 17.114,log_totchol = 0.940,log_hdl = -18.920, log_agexhdl = 4.475,log_SBP = 29.291,log_agexsbp = -6.432,curr_smq = 0.691,Diabetes = 0.874)
##  beta coeff for males Blacks
### ** __males dont have age^2 factor__ **
mblack_coeff <- list(log_age = 2.469,log_totchol = 0.302,log_hdl = -0.307,log_SBP = 1.916,curr_smq = 0.549,Diabetes = 0.645)

# 10-year Baseline Survival rate 
## females
f_base10 = 0.9665
## males
m_base10 = 0.9144	

# males and whites
sum_MW = function(age,hdl,totchol,asbp,smoker,diabetic) {
  sum = sum((mwhite_coeff[[1]]*log(age)),(mwhite_coeff[[2]]*log(totchol)),(mwhite_coeff[[3]]*log(totchol)*log(age)),(mwhite_coeff[[4]]*log(hdl)),(mwhite_coeff[[5]]*log(hdl)*log(age)),(mwhite_coeff[[6]]*log(asbp)),(mwhite_coeff[[7]]*smoker),(mwhite_coeff[[8]]*smoker*log(age)),(mwhite_coeff[[9]]*diabetic))
  return(sum)
}
# males and blacks
sum_MB = function(age,hdl,totchol,asbp,smoker,diabetic) {
  sum = sum(mblack_coeff[[1]]*log(age),mblack_coeff[[2]]*log(totchol),mblack_coeff[[3]]*log(hdl),mblack_coeff[[4]]*log(asbp),mblack_coeff[[5]]*smoker,mblack_coeff[[6]]*diabetic)
  return(sum)
}
# females and whites
sum_FW = function(age,hdl,totchol,asbp,smoker,diabetic) {
  sum = sum((fwhite_coeff[[1]]*log(age)),(fwhite_coeff[[2]]*log(age)^2),(fwhite_coeff[[3]]*log(totchol)),(fwhite_coeff[[4]]*log(totchol)*log(age)),(fwhite_coeff[[5]]*log(hdl)),(fwhite_coeff[[6]]*log(hdl)*log(age)),(fwhite_coeff[[7]]*log(asbp)),(fwhite_coeff[[8]]*smoker),(fwhite_coeff[[9]]*smoker*log(age)),(fwhite_coeff[[10]]*diabetic))
  return(sum)
}
# females and blakcs
sum_FB = function(age,hdl,totchol,asbp,smoker,diabetic) {
  sum = sum((fblack_coeff[[1]]*log(age)),(fblack_coeff[[2]]*log(totchol)),(fblack_coeff[[3]]*log(hdl)),(fblack_coeff[[4]]*log(hdl)*log(age)),(fblack_coeff[[5]]*log(asbp)),(fblack_coeff[[6]]*log(asbp)*log(age)),(fblack_coeff[[7]]*smoker),(fblack_coeff[[8]]*diabetic))
return(sum)
  }


get_pooled_frs = function(survey,sex,race,age,hdl,totchol,asbp,smoker,diabetic) {
  #### MALES ####
  if (sex == 1 & race == 1) {
   ind_sum = sum_MW(age,hdl,totchol,asbp,smoker,diabetic)#;print(ind_sum)#;print(get(paste0(survey,"_means"))[1,1])
   int = ind_sum - get(paste0(survey,"_means"))[1,1]
   rho = 1 - (m_base10^(exp(int)))
  }
  else if (sex == 1 & race == 2) {
   ind_sum = sum_MB(age,hdl,totchol,asbp,smoker,diabetic)#;print(ind_sum)
   int = ind_sum - get(paste0(survey,"_means"))[3,1]#;print(int);print(get(paste0(survey,"_means"))[3,1])
   rho = 1 - (m_base10^(exp(int)))
  }
  #### FEMALES ####
 else if (sex==2 & race==1){
    ind_sum = sum_FW(age,hdl,totchol,asbp,smoker,diabetic)#;print(ind_sum);print(get(paste0(survey,"_means"))[2,1])
    int = ind_sum - get(paste0(survey,"_means"))[2,1]#;print(int)
    rho = 1 - (f_base10^(exp(int)))
 }
  else if (sex==2 & race==2){
    ind_sum = sum_FB(age,hdl,totchol,asbp,smoker,diabetic)#;print(ind_sum);print(get(paste0(survey,"_means"))[4,1])
    int = ind_sum - get(paste0(survey,"_means"))[4,1]
    rho = 1 - (f_base10^(exp(int)))
  }
  
  return(rho*100)
}

```

## NHANES II
```{r}

nhanesII_atp3 = read_dta("/Users/bryankim/Documents/NBER/Case Deaton/Data/FRS/ATP3/nhanesII_frs_atp3.dta") %>% filter(RACE != 3) %>% mutate(isDiabetic = ifelse(fpg_reg >= 126, 1,0))

# Race-Sex specific means
source("/Users/bryankim/Documents/NBER/Case Deaton/Code/NHANES II&III/get_racesex_means.R")

nhanesII = nhanesII %>% mutate(MW = ifelse(RACE == 1 & SEX == 1, 1, 0))
nhanesII = nhanesII %>% mutate(FW = ifelse(RACE == 1 & SEX == 2, 1, 0))
nhanesII = nhanesII %>% mutate(MB = ifelse(RACE == 2 & SEX == 1, 1, 0))
nhanesII = nhanesII %>% mutate(FB = ifelse(RACE == 2 & SEX == 2, 1, 0))
# coalesce into one variable `race_sex_cat`
nhanesII$race_sex_cat = ifelse(nhanesII$MW==1, 1, NA)
nhanesII$race_sex_cat[nhanesII$FW == 1] = 2
nhanesII$race_sex_cat[nhanesII$MB == 1] = 3
nhanesII$race_sex_cat[nhanesII$FB == 1] = 4

nhanesII$pooled_frs = get_pooled_frs %>% mapply("nhanesII",nhanesII$RACE,nhanesII$SEX,nhanesII$AGEYR_AT_INT,nhanesII$lbdhdd,nhanesII$lbxtc,nhanesII$asbp,nhanesII$curr_smq,nhanesII$isDiabetic)

```
